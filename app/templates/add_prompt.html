{% extends "base.html" %}
{% block content %}
<div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
  <!-- Header -->
  <div class="mb-8">
    <h1 class="text-3xl font-bold text-gray-900">Add New Prompt</h1>
    <p class="text-gray-600 mt-2">Create and sell your AI prompts to the community</p>
  </div>

  <!-- Form -->
  <div class="bg-white shadow rounded-lg">
    <div class="px-6 py-4 border-b border-gray-200">
      <h3 class="text-lg font-medium text-gray-900">Prompt Details</h3>
    </div>
    
    <form id="add-prompt-form" class="p-6 space-y-6">
      <!-- Title -->
      <div>
        <label for="title" class="block text-sm font-medium text-gray-700 mb-2">
          Prompt Title *
        </label>
        <input 
          type="text" 
          id="title" 
          name="title" 
          required
          class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors duration-200"
          placeholder="e.g., Professional Email Writer for Business"
        >
        <p class="mt-1 text-sm text-gray-500">Choose a clear, descriptive title that explains what your prompt does</p>
      </div>

      <!-- Description -->
      <div class="mb-6">
        <label for="description" class="block text-sm font-medium text-gray-700 mb-2">Description</label>
        <textarea id="description" name="description" rows="3" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors duration-200" placeholder="Describe your prompt..." required></textarea>
      </div>
      
      <div class="mb-6">
        <label for="prompt-image" class="block text-sm font-medium text-gray-700 mb-2">Prompt Image (Optional)</label>
        <div class="mt-1 flex justify-center px-6 pt-5 pb-6 border-2 border-gray-300 border-dashed rounded-lg hover:border-gray-400 transition-colors duration-200">
          <div class="space-y-1 text-center">
            <svg class="mx-auto h-12 w-12 text-gray-400" stroke="currentColor" fill="none" viewBox="0 0 48 48">
              <path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8m-12 4h.02" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
            </svg>
            <div class="flex text-sm text-gray-600">
              <label for="prompt-image" class="relative cursor-pointer bg-white rounded-md font-medium text-blue-600 hover:text-blue-500 focus-within:outline-none focus-within:ring-2 focus-within:ring-offset-2 focus-within:ring-blue-500">
                <span>Upload an image</span>
                <input id="prompt-image" name="prompt-image" type="file" class="sr-only" accept="image/*">
              </label>
              <p class="pl-1">or drag and drop</p>
            </div>
            <p class="text-xs text-gray-500">PNG, JPG, GIF up to 10MB</p>
          </div>
        </div>
        <div id="image-preview" class="mt-4 hidden">
          <img id="preview-img" class="max-w-xs rounded-lg shadow-md" alt="Preview">
          <button type="button" onclick="removeImage()" class="mt-2 px-3 py-1 text-sm text-red-600 hover:text-red-800">Remove Image</button>
        </div>
      </div>

      <!-- Content -->
      <div>
        <label for="content" class="block text-sm font-medium text-gray-700 mb-2">
          Prompt Content *
        </label>
        <textarea 
          id="content" 
          name="content" 
          required
          rows="8"
          class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors duration-200 font-mono text-sm"
          placeholder="Write your AI prompt here. You can use placeholders like [TOPIC], [TONE], [LENGTH] that buyers can customize..."
        ></textarea>
        <p class="mt-1 text-sm text-gray-500">This is the actual prompt that buyers will receive. Use clear instructions and placeholders for customization.</p>
      </div>

      <!-- Tags -->
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-2">
          Tags (up to 5)
        </label>
        <div class="space-y-2">
          <div class="flex flex-wrap gap-2" id="selected-tags"></div>
          <div class="flex gap-2">
            <input 
              type="text" 
              id="tag-input" 
              class="flex-1 px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors duration-200"
              placeholder="Add a tag (e.g., Marketing, SEO, Creative)"
            >
            <button 
              type="button"
              onclick="addTag()"
              class="px-4 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors duration-200"
            >
              Add
            </button>
          </div>
        </div>
        <p class="mt-1 text-sm text-gray-500">Tags help buyers find your prompt. Use relevant keywords.</p>
      </div>

      <!-- License Type -->
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-2">
          License Type *
        </label>
        <div class="space-y-3">
          <label class="flex items-center">
            <input type="radio" name="license_type" value="personal" checked class="mr-3">
            <div>
              <div class="font-medium">Personal</div>
              <div class="text-sm text-gray-500">For individual use only</div>
            </div>
          </label>
          <label class="flex items-center">
            <input type="radio" name="license_type" value="commercial" class="mr-3">
            <div>
              <div class="font-medium">Commercial</div>
              <div class="text-sm text-gray-500">For business and commercial use</div>
            </div>
          </label>
          <label class="flex items-center">
            <input type="radio" name="license_type" value="commercial-derivative" class="mr-3">
            <div>
              <div class="font-medium">Commercial + Derivatives</div>
              <div class="text-sm text-gray-500">Can be modified and used commercially</div>
            </div>
          </label>
        </div>
      </div>

      <!-- Price -->
      <div>
        <label for="price" class="block text-sm font-medium text-gray-700 mb-2">
          Price (USD) *
        </label>
        <div class="relative">
          <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
            <span class="text-gray-500 sm:text-sm">$</span>
          </div>
          <input 
            type="number" 
            id="price" 
            name="price" 
            required
            min="1"
            max="100"
            step="0.01"
            value="5.00"
            class="w-full pl-8 pr-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors duration-200"
            placeholder="5.00"
          >
        </div>
        <p class="mt-1 text-sm text-gray-500">Set a fair price. You'll receive 90% of each sale.</p>
      </div>

      <!-- Revenue Info -->
      <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
        <div class="flex items-center">
          <svg class="w-5 h-5 text-blue-600 mr-2" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path>
          </svg>
          <div>
            <p class="text-blue-800 text-sm">
              <strong>Revenue Split:</strong> You keep 90% of each sale, we take 10% as platform fee.
            </p>
            <p class="text-blue-700 text-xs mt-1">
              Example: For a $5 prompt, you earn $4.50 per sale.
            </p>
          </div>
        </div>
      </div>

      <!-- Submit Button -->
      <div class="flex justify-end space-x-4">
        <a href="/dashboard" class="px-6 py-3 text-sm font-medium text-gray-700 bg-gray-100 rounded-lg hover:bg-gray-200 transition-colors duration-200">
          Cancel
        </a>
        <button 
          type="submit" 
          class="px-6 py-3 text-sm font-medium bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors duration-200 flex items-center"
        >
          <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
          </svg>
          Create Prompt
        </button>
      </div>
    </form>
  </div>

  <!-- Tips Section -->
  <div class="mt-8 bg-gray-50 rounded-lg p-6">
    <h3 class="text-lg font-medium text-gray-900 mb-4">Tips for Creating Great Prompts</h3>
    <div class="grid md:grid-cols-2 gap-6">
      <div>
        <h4 class="font-medium text-gray-900 mb-2">Structure Your Prompt</h4>
        <ul class="text-sm text-gray-600 space-y-1">
          <li>• Start with a clear role or context</li>
          <li>• Provide specific instructions</li>
          <li>• Use placeholders for customization</li>
          <li>• Include examples when helpful</li>
        </ul>
      </div>
      <div>
        <h4 class="font-medium text-gray-900 mb-2">Pricing Strategy</h4>
        <ul class="text-sm text-gray-600 space-y-1">
          <li>• Simple prompts: $1-3</li>
          <li>• Complex prompts: $3-10</li>
          <li>• Specialized prompts: $10+</li>
          <li>• Consider the value you're providing</li>
        </ul>
      </div>
    </div>
  </div>
</div>

<script>
let selectedTags = [];

function addTag() {
  const tagInput = document.getElementById('tag-input');
  const tag = tagInput.value.trim();
  
  if (tag && selectedTags.length < 5 && !selectedTags.includes(tag)) {
    selectedTags.push(tag);
    updateTagDisplay();
    tagInput.value = '';
  }
}

function removeTag(tag) {
  selectedTags = selectedTags.filter(t => t !== tag);
  updateTagDisplay();
}

function updateTagDisplay() {
  const container = document.getElementById('selected-tags');
  container.innerHTML = '';
  
  selectedTags.forEach(tag => {
    const tagElement = document.createElement('span');
    tagElement.className = 'inline-flex items-center px-3 py-1 rounded-full text-sm bg-blue-100 text-blue-800';
    tagElement.innerHTML = `
      ${tag}
      <button type="button" onclick="removeTag('${tag}')" class="ml-2 text-blue-600 hover:text-blue-800">
        ×
      </button>
    `;
    container.appendChild(tagElement);
  });
}

document.getElementById('add-prompt-form').addEventListener('submit', async function(e) {
  e.preventDefault();
  
  const token = localStorage.getItem("pm_token");
  if (!token) {
    alert("Please log in to create a prompt");
    window.location.href = "/";
    return;
  }

  const formData = new FormData(e.target);
  const licenseType = formData.get('license_type') || 'personal';
  
  const data = {
    title: formData.get('title'),
    description: formData.get('description'),
    content: formData.get('content'),
    price_cents: Math.round(parseFloat(formData.get('price')) * 100),
    tags: selectedTags,
    license_type: licenseType
  };

  try {
    const response = await fetch('/api/prompts', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${token}`
      },
      body: JSON.stringify(data)
    });

    if (response.ok) {
      const result = await response.json();
      alert('Prompt created successfully!');
      window.location.href = `/prompts/${result.id}`;
    } else {
      const error = await response.json();
      alert('Error creating prompt: ' + (error.detail || 'Unknown error'));
    }
  } catch (error) {
    console.error('Error:', error);
    alert('Error creating prompt. Please try again.');
  }
});

// Auto-format price input
document.getElementById('price').addEventListener('input', function(e) {
  let value = e.target.value;
  if (value && !isNaN(value)) {
    const num = parseFloat(value);
    if (num < 1) e.target.value = 1;
    if (num > 100) e.target.value = 100;
  }
});

// Allow Enter key to add tags
document.getElementById('tag-input').addEventListener('keypress', function(e) {
  if (e.key === 'Enter') {
    e.preventDefault();
    addTag();
  }
});

// Image preview functionality
document.getElementById('prompt-image').addEventListener('change', function(e) {
  const file = e.target.files[0];
  if (file) {
    const reader = new FileReader();
    reader.onload = function(e) {
      document.getElementById('preview-img').src = e.target.result;
      document.getElementById('image-preview').classList.remove('hidden');
    };
    reader.readAsDataURL(file);
  }
});

function removeImage() {
  document.getElementById('prompt-image').value = '';
  document.getElementById('image-preview').classList.add('hidden');
}

// Form submission with image
document.getElementById('add-prompt-form').addEventListener('submit', async function(e) {
  e.preventDefault();
  
  const formData = new FormData();
  formData.append('title', document.getElementById('title').value);
  formData.append('content', document.getElementById('content').value);
  formData.append('description', document.getElementById('description').value);
  formData.append('price', document.getElementById('price').value);
  formData.append('license_type', document.getElementById('license_type').value);
  
  const imageFile = document.getElementById('prompt-image').files[0];
  if (imageFile) {
    formData.append('image', imageFile);
  }
  
  const token = localStorage.getItem('pm_token');
  if (!token) {
    alert('Please log in to create prompts');
    return;
  }
  
  try {
    const response = await fetch('/api/prompts', {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${token}`
      },
      body: formData
    });
    
    if (response.ok) {
      alert('Prompt created successfully!');
      window.location.href = '/dashboard';
    } else {
      const error = await response.json();
      alert(`Error: ${error.detail}`);
    }
  } catch (error) {
    console.error('Error creating prompt:', error);
    alert('Error creating prompt');
  }
});
</script>
{% endblock %} 