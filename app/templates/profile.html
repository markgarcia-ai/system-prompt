{% extends "base.html" %}

{% block content %}
<div class="min-h-screen bg-gray-50 py-8">
  <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">
    <div class="bg-white rounded-lg shadow-sm border border-gray-200">
      <!-- Header -->
      <div class="px-6 py-4 border-b border-gray-200">
        <h1 class="text-2xl font-bold text-gray-900">Profile Settings</h1>
        <p class="text-gray-600 mt-1">Manage your account information and preferences</p>
      </div>

      <div class="p-6">
        <!-- Profile Information -->
        <div class="mb-8">
          <h2 class="text-lg font-semibold text-gray-900 mb-4">Profile Information</h2>
          <form id="profile-form" class="space-y-4">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <label for="first_name" class="block text-sm font-medium text-gray-700 mb-1">First Name</label>
                <input type="text" id="first_name" name="first_name" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
              </div>
              <div>
                <label for="last_name" class="block text-sm font-medium text-gray-700 mb-1">Last Name</label>
                <input type="text" id="last_name" name="last_name" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
              </div>
            </div>
            <div>
              <label for="bio" class="block text-sm font-medium text-gray-700 mb-1">Bio</label>
              <textarea id="bio" name="bio" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="Tell us about yourself..."></textarea>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <label for="website" class="block text-sm font-medium text-gray-700 mb-1">Website</label>
                <input type="url" id="website" name="website" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="https://example.com">
              </div>
              <div>
                <label for="location" class="block text-sm font-medium text-gray-700 mb-1">Location</label>
                <input type="text" id="location" name="location" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="City, Country">
              </div>
            </div>
            <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors duration-200">
              Update Profile
            </button>
          </form>
        </div>

        <!-- Avatar Upload -->
        <div class="mb-8">
          <h2 class="text-lg font-semibold text-gray-900 mb-4">Profile Picture</h2>
          <div class="flex items-center space-x-4">
            <div class="w-20 h-20 rounded-full bg-gray-200 flex items-center justify-center overflow-hidden">
              <img id="avatar-preview" src="/static/images/default-avatar.png" alt="Avatar" class="w-full h-full object-cover">
            </div>
            <div>
              <input type="file" id="avatar-upload" accept="image/*" class="hidden">
              <button onclick="document.getElementById('avatar-upload').click()" class="px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition-colors duration-200">
                Upload New Picture
              </button>
            </div>
          </div>
        </div>

        <!-- Payment Information -->
        <div class="mb-8">
          <h2 class="text-lg font-semibold text-gray-900 mb-4">Payment Information</h2>
          <div class="space-y-4">
            <div>
              <label for="paypal_email" class="block text-sm font-medium text-gray-700 mb-1">PayPal Email (for withdrawals)</label>
              <input type="email" id="paypal_email" name="paypal_email" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="your-paypal@example.com">
            </div>
            <div class="bg-blue-50 p-4 rounded-lg">
              <h3 class="font-medium text-blue-900 mb-2">Account Balance</h3>
              <p class="text-2xl font-bold text-blue-900" id="balance">$0.00</p>
              <button class="mt-2 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors duration-200">
                Request Withdrawal
              </button>
            </div>
          </div>
        </div>

        <!-- Change Password -->
        <div class="mb-8">
          <h2 class="text-lg font-semibold text-gray-900 mb-4">Change Password</h2>
          <form id="password-form" class="space-y-4">
            <div>
              <label for="current_password" class="block text-sm font-medium text-gray-700 mb-1">Current Password</label>
              <input type="password" id="current_password" name="current_password" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" required>
            </div>
            <div>
              <label for="new_password" class="block text-sm font-medium text-gray-700 mb-1">New Password</label>
              <input type="password" id="new_password" name="new_password" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" required>
            </div>
            <button type="submit" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors duration-200">
              Change Password
            </button>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  // Load profile data
  async function loadProfile() {
    const token = localStorage.getItem('pm_token');
    if (!token) {
      window.location.href = '/';
      return;
    }

    try {
      const response = await fetch('/api/auth/me', {
        headers: { 'Authorization': `Bearer ${token}` }
      });
      
      if (response.ok) {
        const profile = await response.json();
        
        // Populate form fields
        document.getElementById('first_name').value = profile.first_name || '';
        document.getElementById('last_name').value = profile.last_name || '';
        document.getElementById('bio').value = profile.bio || '';
        document.getElementById('website').value = profile.website || '';
        document.getElementById('location').value = profile.location || '';
        document.getElementById('paypal_email').value = profile.paypal_email || '';
        
        // Update balance
        const balance = (profile.balance_cents / 100).toFixed(2);
        document.getElementById('balance').textContent = `$${balance}`;
        
        // Update avatar
        if (profile.avatar_url) {
          document.getElementById('avatar-preview').src = profile.avatar_url;
        }
      }
    } catch (error) {
      console.error('Error loading profile:', error);
    }
  }

  // Profile form submission
  document.getElementById('profile-form').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const formData = {
      first_name: document.getElementById('first_name').value,
      last_name: document.getElementById('last_name').value,
      bio: document.getElementById('bio').value,
      website: document.getElementById('website').value,
      location: document.getElementById('location').value,
      paypal_email: document.getElementById('paypal_email').value
    };

    const token = localStorage.getItem('pm_token');
    
    try {
      const response = await fetch('/api/auth/profile', {
        method: 'PUT',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${token}`
        },
        body: JSON.stringify(formData)
      });
      
      if (response.ok) {
        alert('Profile updated successfully!');
      } else {
        const error = await response.json();
        alert(`Error: ${error.detail}`);
      }
    } catch (error) {
      console.error('Error updating profile:', error);
      alert('Error updating profile');
    }
  });

  // Password form submission
  document.getElementById('password-form').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const formData = {
      current_password: document.getElementById('current_password').value,
      new_password: document.getElementById('new_password').value
    };

    const token = localStorage.getItem('pm_token');
    
    try {
      const response = await fetch('/api/auth/password', {
        method: 'PUT',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${token}`
        },
        body: JSON.stringify(formData)
      });
      
      if (response.ok) {
        alert('Password updated successfully!');
        document.getElementById('password-form').reset();
      } else {
        const error = await response.json();
        alert(`Error: ${error.detail}`);
      }
    } catch (error) {
      console.error('Error updating password:', error);
      alert('Error updating password');
    }
  });

  // Avatar upload
  document.getElementById('avatar-upload').addEventListener('change', async function(e) {
    const file = e.target.files[0];
    if (!file) return;

    const formData = new FormData();
    formData.append('file', file);

    const token = localStorage.getItem('pm_token');
    
    try {
      const response = await fetch('/api/auth/avatar', {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${token}`
        },
        body: formData
      });
      
      if (response.ok) {
        const data = await response.json();
        document.getElementById('avatar-preview').src = data.avatar_url;
        alert('Avatar updated successfully!');
      } else {
        const error = await response.json();
        alert(`Error: ${error.detail}`);
      }
    } catch (error) {
      console.error('Error uploading avatar:', error);
      alert('Error uploading avatar');
    }
  });

  // Load profile on page load
  loadProfile();
</script>
{% endblock %} 